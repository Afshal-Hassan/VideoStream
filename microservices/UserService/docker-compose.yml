version: "3"

services:
  service-registry:
    image: afshalhassan/service-registry-youtube:0.0.1.SNAPSHOT
    container_name: service-registry
    ports:
      - "9000:9000"
    networks:
      - backend

  dbservice:
    image: mysql:8
    container_name: mysql
    environment:
      MYSQL_DATABASE: user
      MYSQL_ROOT_PASSWORD: root
    volumes:
      - ./data:/var/lib/mysql
    ports:
      - "3307:3306"
    networks:
      - backend

  redis:
    image: redis:6.0.7
    container_name: redis
    restart: always
    volumes:
      - ./data:/var/lib/redis
    ports:
      - "6379:6379"
    networks:
      - backend

  redis_insight:
    image: redislabs/redisinsight:latest
    container_name: redis_insight
    restart: always
    volumes:
      - ./data:/var/lib/redisinsight
    ports:
      - "9001:9001"
    networks:
      - backend

  api-gateway:
    image: afshalhassan/api-gateway-youtube:latest
    container_name: api-gateway
    ports:
      - "9050:9050"
    environment:
      - EUREKA_CLIENT_SERVICE-URL_DEFAULTZONE=http://service-registry:9000/eureka
      - EUREKA_INSTANCE_PREFER-IP-ADDRESS=true
      - EUREKA_CLIENT_REGISTER-WITH-EUREKA=true
      - EUREKA_CLIENT_FETCH-REGISTRY=true
    networks:
      - backend
    depends_on:
      - service-registry

  auth-service:
    image: afshalhassan/user-service-youtube:0.0.1.SNAPSHOT
    container_name: auth-service
    ports:
      - "8080:8080"
    environment:
      - SPRING_DATASOURCE_URL=jdbc:mysql://mysql:3306/user
      - SPRING_DATASOURCE_USERNAME=root
      - SPRING_DATASOURCE_PASSWORD=root
      - SPRING_DATASOURCE_DRIVER-CLASS-NAME=com.mysql.cj.jdbc.Driver
      - SPRING_JPA_HIBERNATE_DDL-AUTO=update
      - SPRING_JPA_SHOW-SQL=true
      - EUREKA_CLIENT_SERVICE-URL_DEFAULTZONE=http://service-registry:9000/eureka
      - EUREKA_INSTANCE_PREFER-IP-ADDRESS=true
      - EUREKA_CLIENT_REGISTER-WITH-EUREKA=true
      - EUREKA_CLIENT_FETCH-REGISTRY=true
    networks:
      - backend
    depends_on:
      - service-registry
      - dbservice

  video-service:
    image: afshalhassan/video-service-youtube:0.0.1.SNAPSHOT
    container_name: video-service
    ports:
      - "8081:8081"
    environment:
      - SPRING_DATASOURCE_URL=r2dbc:mysql://mysql:3306/video
      - SPRING_DATASOURCE_USERNAME=root
      - SPRING_DATASOURCE_PASSWORD=root
      - SPRING_DATASOURCE_DRIVER-CLASS-NAME=mysql
      - SPRING_JPA_HIBERNATE_DDL-AUTO=update
      - SPRING_JPA_SHOW-SQL=true
      - EUREKA_CLIENT_SERVICE-URL_DEFAULTZONE=http://service-registry:9000/eureka
      - EUREKA_INSTANCE_PREFER-IP-ADDRESS=true
      - EUREKA_CLIENT_REGISTER-WITH-EUREKA=true
      - EUREKA_CLIENT_FETCH-REGISTRY=true
      - FILES_DIR_PATH=/home/app/uploads/videos
    volumes:
      - ./data:/home/app/uploads/videos
    networks:
      - backend
    depends_on:
      - service-registry
      - dbservice
      - redis

networks:
  backend:
    driver: bridge
